<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-http="http://www.springframework.org/schema/integration/http"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

    <!-- BASIC CHANNELS -->
    <int:channel id="inputChannel"/>
    <int:channel id="validationChannel"/>
    <int:channel id="transformationChannel"/>
    <int:channel id="outputChannel"/>
    <int:channel id="invalidMessageChannel"/>

    <!-- MESSAGE ENRICHER -->
    <int:enricher id="messageEnricher"
                  input-channel="inputChannel"
                  output-channel="validationChannel">
        <int:header name="enrichedTimestamp" expression="T(System).currentTimeMillis()"/>
        <int:header name="correlationId" expression="T(java.util.UUID).randomUUID().toString()"/>
        <int:header name="source" expression="'EIP-BASIC-DEMO'"/>
        <int:header name="stage" expression="'ENRICHED'"/>
    </int:enricher>

    <!-- MESSAGE FILTER -->
    <int:filter id="messageValidator"
                input-channel="validationChannel"
                output-channel="transformationChannel"
                discard-channel="invalidMessageChannel"
                expression="payload != null and payload.toString().trim().length() > 0"/>

    <!-- MESSAGE TRANSFORMER -->
    <int:transformer id="messageTransformer"
                     input-channel="transformationChannel"
                     output-channel="outputChannel"
                     expression="'PROCESSED: ' + payload.toString().toUpperCase()"/>

    <!-- SERVICE ACTIVATOR -->
    <int:service-activator input-channel="outputChannel"
                           ref="messageProcessor"
                           method="handle"/>
    
    <bean id="messageProcessor" class="com.ads.apiseng.handlers.SimpleHandler">
        <constructor-arg value="BASIC-PROCESSOR"/>
    </bean>

    <!-- DEAD LETTER HANDLER -->
    <int:service-activator input-channel="invalidMessageChannel"
                           ref="errorHandler"
                           method="handle"/>
    
    <bean id="errorHandler" class="com.ads.apiseng.handlers.SimpleHandler">
        <constructor-arg value="ERROR-HANDLER"/>
    </bean>

    <!-- HTTP ENDPOINT -->
    <int-http:inbound-gateway id="httpEndpoint"
                              supported-methods="POST"
                              request-channel="inputChannel"
                              path="/api/basic-transform"
                              reply-timeout="30000"/>

</beans>