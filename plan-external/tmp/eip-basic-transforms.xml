<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-http="http://www.springframework.org/schema/integration/http"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           https://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/integration
           https://www.springframework.org/schema/integration/spring-integration.xsd
           http://www.springframework.org/schema/integration/http
           https://www.springframework.org/schema/integration/http/spring-integration-http.xsd">

    <!-- BASIC CHANNELS -->
    <int:channel id="inputChannel"/>
    <int:channel id="validationChannel"/>
    <int:channel id="invalidMessageChannel"/>

    <!-- MESSAGE ENRICHER -->
    <int:enricher id="messageEnricher"
                  input-channel="inputChannel"
                  output-channel="validationChannel">
        <int:header name="enrichedTimestamp" expression="T(System).currentTimeMillis()"/>
        <int:header name="correlationId" expression="T(java.util.UUID).randomUUID().toString()"/>
        <int:header name="source" expression="'EIP-BASIC-DEMO'"/>
        <int:header name="stage" expression="'ENRICHED'"/>
    </int:enricher>

    <!-- MESSAGE FILTER -->
    <int:filter id="messageValidator"
                input-channel="validationChannel"
                output-channel="transformationChannel"
                discard-channel="invalidMessageChannel"
                expression="payload != null and payload.toString().trim().length() > 0"/>

    <!-- MESSAGE TRANSFORMER -->
    <int:transformer id="messageTransformer"
                     input-channel="transformationChannel"
                     output-channel="processedChannel"
                     expression="'PROCESSED: ' + payload.toString().toUpperCase()"/>

    <!-- PUBLISH-SUBSCRIBE CHANNEL (reply + logging) -->
    <int:publish-subscribe-channel id="processedChannel"/>

    <!-- LOGGER: log only the payload after processing -->
    <int:logging-channel-adapter id="processedLogger"
                                 channel="processedChannel"
                                 level="INFO"
                                 expression="payload"/>

    <!-- DEAD LETTER HANDLER -->
    <int:logging-channel-adapter id="errorHandler"
                                 channel="invalidMessageChannel"
                                 level="ERROR"
                                 log-full-message="true"/>

    <!-- HTTP ENDPOINT -->
    <int-http:inbound-gateway id="httpEndpoint"
                              supported-methods="POST"
                              request-channel="inputChannel"
                              reply-channel="processedChannel"
                              path="/api/basic-transform"
                              reply-timeout="3000"/>
</beans>
